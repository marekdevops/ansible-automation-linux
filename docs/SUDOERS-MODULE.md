# Moduł SUDOERS - Dokumentacja

## Opis
Moduł `sudoers` służy do konfiguracji uprawnień sudo dla użytkowników na podstawie pliku z komendami. Tworzy plik w `/etc/sudoers.d/` pozwalający użytkownikowi wykonywać określone komendy bez hasła.

## Podstawowe użycie

### Składnia
```bash
./run-automation.sh sudoers -e "user=NAZWA [opcje]"
```

### Wymagane parametry
- `user` - nazwa użytkownika dla którego konfigurujemy sudo

### Opcjonalne parametry
- `commands_file` - nazwa pliku z komendami (domyślnie: `sudo_commands`)
- `priority` - priorytet pliku sudoers (domyślnie: `98`)

## Jak to działa

### 1. Plik z komendami
W katalogu `templates/` znajduje się plik z komendami (domyślnie `sudo_commands`):
```
# Komendy oddzielone średnikiem
/usr/bin/systemctl restart nginx;/usr/bin/systemctl reload nginx
/usr/bin/docker ps;/usr/bin/docker images
/bin/chmod +x /opt/scripts/*
```

### 2. Generowanie pliku sudoers
Moduł tworzy plik `/etc/sudoers.d/98-UŻYTKOWNIK` z zawartością:
```
# Sudoers file for user: webmaster
# Generated by Ansible on 2025-10-10T12:00:00Z

webmaster ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
webmaster ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx
webmaster ALL=(ALL) NOPASSWD: /usr/bin/docker ps
webmaster ALL=(ALL) NOPASSWD: /usr/bin/docker images
webmaster ALL=(ALL) NOPASSWD: /bin/chmod +x /opt/scripts/*
```

## Przykłady użycia

### 1. Podstawowa konfiguracja
```bash
# Używa domyślnego pliku sudo_commands
./run-automation.sh sudoers -e "user=webmaster"
```

### 2. Własny plik z komendami
```bash
# Najpierw utwórz plik templates/admin_commands z komendami
./run-automation.sh sudoers -e "user=admin commands_file=admin_commands"
```

### 3. Niestandardowy priorytet
```bash
# Tworzy plik 99-admin zamiast 98-admin
./run-automation.sh sudoers -e "user=admin priority=99"
```

### 4. Dry-run (sprawdzenie)
```bash
# Sprawdź co zostanie utworzone bez wprowadzania zmian
./run-automation.sh sudoers -e "user=webmaster" -c
```

## Tworzenie własnych plików z komendami

### Lokalizacja
Pliki z komendami należy umieścić w katalogu `templates/`

### Format pliku
```
# Komentarze zaczynające się od #
/pełna/ścieżka/do/komendy1;/pełna/ścieżka/do/komendy2
/inna/komenda/w/osobnej/linii
/komenda/z/argumentami * argument;/inna/komenda
```

### Przykładowe pliki komend

#### `templates/webmaster_commands`
```
# Komendy dla webmastera
/usr/bin/systemctl restart nginx;/usr/bin/systemctl reload nginx;/usr/bin/systemctl status nginx
/usr/bin/systemctl restart apache2;/usr/bin/systemctl reload apache2
/bin/chmod +x /var/www/scripts/*
/usr/bin/tail -f /var/log/nginx/*.log;/usr/bin/tail -f /var/log/apache2/*.log
```

#### `templates/docker_admin_commands`
```
# Komendy Docker dla administratora
/usr/bin/docker ps;/usr/bin/docker images;/usr/bin/docker logs *
/usr/bin/docker start *;/usr/bin/docker stop *;/usr/bin/docker restart *
/usr/bin/docker-compose up -d;/usr/bin/docker-compose down
/usr/bin/docker system prune -f
```

#### `templates/backup_operator_commands`
```
# Komendy dla operatora backupów
/usr/bin/rsync * *;/usr/bin/scp * *
/bin/mount;/bin/umount /backup/*
/usr/bin/tar czf * *;/usr/bin/tar xzf *
/usr/sbin/service mysql stop;/usr/sbin/service mysql start
```

## Zarządzanie plikami sudoers

### Sprawdzenie aktualnych uprawnień
```bash
# Sprawdź uprawnienia użytkownika
sudo -l -U UŻYTKOWNIK

# Pokaż wszystkie pliki sudoers
ls -la /etc/sudoers.d/
```

### Usuwanie uprawnień
```bash
# Usuń plik sudoers dla użytkownika
sudo rm /etc/sudoers.d/98-UŻYTKOWNIK
```

### Edycja uprawnień
```bash
# Edytuj plik komend i uruchom ponownie moduł
vim templates/sudo_commands
./run-automation.sh sudoers -e "user=UŻYTKOWNIK"
```

## Bezpieczeństwo

### Dobre praktyki
1. **Używaj pełnych ścieżek** do komend (np. `/usr/bin/systemctl` zamiast `systemctl`)
2. **Ogranicz wildcards** - używaj `*` ostrożnie
3. **Testuj uprawnienia** przed wdrożeniem na produkcji
4. **Regularnie przeglądaj** pliki sudoers
5. **Używaj dry-run** do sprawdzenia zmian

### Przykłady bezpiecznych komend
```
# Dobrze - pełna ścieżka, konkretna komenda
/usr/bin/systemctl restart nginx

# Ostrożnie - wildcard, ale ograniczony
/usr/bin/docker logs container_*

# Unikaj - zbyt szeroki dostęp
/usr/bin/* (NIE UŻYWAJ!)
```

## Rozwiązywanie problemów

### Częste błędy

**Błąd**: "syntax error near line X"
- **Przyczyna**: Błąd składni w pliku sudoers
- **Rozwiązanie**: Sprawdź szablon komend, usuń nieprawidłowe znaki

**Błąd**: "user not found"
- **Przyczyna**: Użytkownik nie istnieje w systemie
- **Rozwiązanie**: Najpierw utwórz użytkownika modułem `user`

**Błąd**: "permission denied"
- **Przyczyna**: Brak uprawnień do katalogu `/etc/sudoers.d/`
- **Rozwiązanie**: Uruchom z uprawnieniami sudo/root

### Diagnostyka

```bash
# Sprawdź składnię sudoers
sudo visudo -c

# Sprawdź uprawnienia użytkownika
sudo -l -U użytkownik

# Sprawdź logi sudo
sudo tail -f /var/log/auth.log | grep sudo

# Test uprawnień (jako użytkownik)
sudo -l
```

## Przykłady zastosowań

### 1. WebMaster
```bash
# Utwórz templates/webmaster_commands:
echo "/usr/bin/systemctl restart nginx;/usr/bin/systemctl reload nginx" > templates/webmaster_commands

# Konfiguruj sudoers
./run-automation.sh sudoers -e "user=webmaster commands_file=webmaster_commands"
```

### 2. Administrator Docker
```bash
# Utwórz templates/docker_commands:
cat > templates/docker_commands << 'EOF'
/usr/bin/docker ps;/usr/bin/docker images
/usr/bin/docker start *;/usr/bin/docker stop *
/usr/bin/docker-compose up -d;/usr/bin/docker-compose down
EOF

# Konfiguruj sudoers
./run-automation.sh sudoers -e "user=dockeradmin commands_file=docker_commands"
```

### 3. Operator backupów
```bash
# Pełny przykład dla operatora backupów
./run-automation.sh user -e "user=backup home=/home/backup"
./run-automation.sh sudoers -e "user=backup commands_file=backup_commands"
```